# AGB SDK Documentation Push to GitHub Pipeline
name: "Push Documentation to GitHub"

params:
  github_repo:
    name: GitHub Repository
    type: string
    default: "agbcloud/agbcloud-docs"
    description: "Target GitHub repository (format: username/repo-name)"
  
  docs_sync_mode:
    name: Documentation Sync Mode
    type: string
    default: "full"
    options:
      - "incremental"  # Only sync changed files
      - "full"         # Fully sync the entire docs directory
    description: "Choose how to sync documentation files"
  
  runs_on_resources:
    name: Resource Specification
    description: "Runtime container resource specification"
    default: "2-8Gi"
    options:
      - "2-8Gi"
      - "4-16Gi"
      - "8-32Gi"

jobs:
  push-docs-to-github:
    continue-on-error: false
    name: "Push Documentation to GitHub"
    runs-on:
      - "${{params.runs_on_resources}}"
    image: alios-8u
    timeout: 20m
    
    steps:
      - uses: checkout
        inputs:
          fetch-depth: 0
          ref: 'master'
          username: 'wuying-ai-team'
          token: ${{secrets.wuying_ai_team_private_token}}
      
      # Check documentation changes
      - id: check-docs-changes
        name: "Check Documentation Changes"
        run: |
          echo "ğŸ“‹ Checking for documentation changes..."
          
          # Check if docs directory exists
          if [ ! -d "docs" ]; then
            echo "âŒ docs directory not found"
            exit 1
          fi
          
          # Check if there are files in docs directory
          DOCS_FILES=$(find docs -type f -name "*.md" 2>/dev/null | wc -l)
          if [ "$DOCS_FILES" -eq 0 ]; then
            echo "âš ï¸ No markdown files found in docs directory"
            exit 1
          fi
          
          echo "âœ… Found $DOCS_FILES documentation files"
          echo "DOCS_FILES_COUNT=$DOCS_FILES" >> $AONE_CI_ENV
          
          # Display documentation structure
          echo "ğŸ“ Documentation structure:"
          tree docs || find docs -type f | head -20
      
      # GitHub connectivity diagnosis step
      - id: github-connectivity-diagnosis
        name: "GitHub Connectivity Diagnosis"
        run: |
          echo "ğŸ” Running GitHub connectivity diagnosis..."
          echo "=================================="
          
          # Basic network connectivity test
          echo "1. Testing basic network connectivity:"
          if ping -c 3 8.8.8.8 > /dev/null 2>&1; then
            echo "   âœ… Internet connectivity: OK"
          else
            echo "   âš ï¸ Internet connectivity: Limited (ping failed, trying HTTP)"
          fi
          
          
          
          # GitHub HTTPS connection
          echo "2. Testing GitHub HTTPS connectivity:"
          if curl -s --connect-timeout 10 https://github.com > /dev/null; then
            echo "   âœ… GitHub HTTPS connection: OK"
          else
            echo "   âŒ GitHub HTTPS connection: FAILED"
          fi
          
          # GitHub API connection
          echo "3. Testing GitHub API connectivity:"
          API_RESPONSE=$(curl -s -w "%{http_code}" https://api.github.com -o /dev/null)
          if [ "$API_RESPONSE" = "200" ]; then
            echo "   âœ… GitHub API connection: OK"
          else
            echo "   âŒ GitHub API connection: FAILED (HTTP $API_RESPONSE)"
          fi
          echo "=================================="
          echo "âœ… Diagnosis completed"
      
      # Validate GitHub configuration
      - id: validate-github-config
        name: "Validate GitHub Configuration"
        run: |
          echo "ğŸ”§ Validating GitHub configuration..."
          
          # Check GitHub Token
          if [ -z "${{secrets.sweetcoder_li_github_token}}" ]; then
            echo "âŒ sweetcoder_li_github_token not configured in GitLab secrets"
            echo "Please add sweetcoder_li_github_token to GitLab CI/CD Variables"
            echo "Required permissions: repo, workflow"
            exit 1
          fi
          
          # Check GitHub username variable
          if [ -z "${{vars.sweetcoder_li_github_username}}" ]; then
            echo "âŒ sweetcoder_li_github_username not configured in GitLab Variables"
            echo "Please add sweetcoder_li_github_username to GitLab CI/CD Variables"
            exit 1
          fi
          
          # Check GitHub email variable
          if [ -z "${{vars.sweetcoder_li_github_email}}" ]; then
            echo "âŒ sweetcoder_li_github_email not configured in GitLab Variables"
            echo "Please add sweetcoder_li_github_email to GitLab CI/CD Variables"
            exit 1
          fi
          
          echo "âœ… GitHub credentials and user information validated"
          echo "  - Token: Configured"
          echo "  - Username: ${{vars.sweetcoder_li_github_username}}"
          echo "  - Email: ${{vars.sweetcoder_li_github_email}}"
          
          # Determine target repository
          GITHUB_REPO="${{params.github_repo}}"
          
          if [ -z "$GITHUB_REPO" ]; then
            echo "âŒ GitHub repository not specified"
            echo "Please set github_repo parameter"
            exit 1
          fi
          
          # Validate repository name format
          if [[ ! "$GITHUB_REPO" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
            echo "âŒ Invalid GitHub repository format: $GITHUB_REPO"
            echo "Expected format: username/repository-name"
            exit 1
          fi
          
          # Test network connectivity
          echo "ğŸŒ Testing network connectivity..."
          if ! ping -c 1 github.com > /dev/null 2>&1; then
            echo "âš ï¸ Cannot ping github.com - checking HTTP connectivity..."
            if ! curl -s --connect-timeout 10 https://github.com > /dev/null; then
              echo "âŒ Cannot reach GitHub - network connectivity issue"
              echo "Please check network configuration and firewall settings"
              exit 1
            fi
          fi
          echo "âœ… Network connectivity to GitHub confirmed"
          
          # Validate GitHub Token basic validity
          echo "ğŸ” Testing GitHub token validity..."
          TOKEN_TEST=$(curl -s -w "%{http_code}" -H "Authorization: token ${{secrets.sweetcoder_li_github_token}}" \
                       "https://api.github.com/user" -o /dev/null)
          
          if [ "$TOKEN_TEST" != "200" ]; then
            echo "âŒ GitHub token validation failed (HTTP $TOKEN_TEST)"
            case "$TOKEN_TEST" in
              "401") echo "  - Token is invalid or expired" ;;
              "403") echo "  - Token has insufficient permissions or rate limited" ;;
              "000") echo "  - Network connection failed" ;;
              *) echo "  - Unexpected error occurred" ;;
            esac
            echo "Please check your GitHub token configuration"
            exit 1
          fi
          echo "âœ… GitHub token is valid"
          
          # Validate target repository access permissions
          echo "ğŸ” Testing repository access..."
          REPO_TEST=$(curl -s -w "%{http_code}" -H "Authorization: token ${{secrets.sweetcoder_li_github_token}}" \
                      "https://api.github.com/repos/${GITHUB_REPO}" -o /dev/null)
          
          if [ "$REPO_TEST" != "200" ]; then
            echo "âŒ Repository access validation failed (HTTP $REPO_TEST)"
            case "$REPO_TEST" in
              "404") echo "  - Repository does not exist or token lacks access" ;;
              "403") echo "  - Token has insufficient permissions for this repository" ;;
              "401") echo "  - Authentication failed" ;;
              *) echo "  - Unexpected error occurred" ;;
            esac
            echo "Please check:"
            echo "  1. Repository ${GITHUB_REPO} exists"
            echo "  2. Token has 'repo' permissions"
            echo "  3. Token owner has access to the repository"
            exit 1
          fi
          echo "âœ… Repository access confirmed"
          
          echo "âœ… GitHub configuration validated"
          echo "  - Repository: $GITHUB_REPO"
          echo "  - Sync Mode: ${{params.docs_sync_mode}}"
          echo "  - Token: Valid and authenticated"
          echo "  - Repository Access: Confirmed"
          
          echo "GITHUB_REPO=$GITHUB_REPO" >> $AONE_CI_ENV
      
      # Push documentation to GitHub
      - id: push-to-github
        name: "Push Documentation to GitHub"
        run: |
          echo "ğŸš€ Starting documentation push to GitHub..."
          
          GITHUB_REPO="${{params.github_repo}}"
          SYNC_MODE="${{params.docs_sync_mode}}"
          
          echo "ğŸ“‹ Push Configuration:"
          echo "  - Repository: $GITHUB_REPO"
          echo "  - Development Branch: (will be randomly generated)"
          echo "  - Base Branch: main"
          echo "  - Sync Mode: $SYNC_MODE"
          echo "  - Files Count: $DOCS_FILES_COUNT"
          
          # Create working directory
          GITHUB_WORK_DIR="$PWD/.github-docs-sync"
          mkdir -p "$GITHUB_WORK_DIR"
          cd "$GITHUB_WORK_DIR"
          
          # Configure Git - Get user information directly from Variables
          echo "ğŸ”§ Configuring Git user information..."

          # Get username and email directly from Variables
          GITHUB_USERNAME="${{vars.sweetcoder_li_github_username}}"
          GITHUB_EMAIL="${{vars.sweetcoder_li_github_email}}"

          echo "ğŸ“‹ Git configuration:"
          echo "  - Username: $GITHUB_USERNAME"
          echo "  - Email: $GITHUB_EMAIL"

          git config --global user.name "$GITHUB_USERNAME"
          git config --global user.email "$GITHUB_EMAIL"
          git config --global init.defaultBranch main

          # Configure Git credential handling to ensure proper use of GitHub Token
          git config --global credential.helper store
          echo "https://${GITHUB_USERNAME}:${{secrets.sweetcoder_li_github_token}}@github.com" > ~/.git-credentials

          echo "âœ… Git configured with GitHub account information"
          
          # Validate GitHub Token and repository access permissions
          echo "ğŸ” Validating GitHub access..."
          
          # Test GitHub API access
          echo "Testing GitHub API access..."
          if ! curl -s -H "Authorization: token ${{secrets.sweetcoder_li_github_token}}" \
               "https://api.github.com/repos/${GITHUB_REPO}" > /dev/null; then
            echo "âŒ Failed to access GitHub API"
            echo "Please check:"
            echo "  1. GitHub token is valid and not expired"
            echo "  2. Token has 'repo' permissions"
            echo "  3. Repository ${GITHUB_REPO} exists and is accessible"
            
            # Test basic GitHub API connectivity
            echo "Testing basic GitHub connectivity..."
            if curl -s "https://api.github.com" > /dev/null; then
              echo "âœ… GitHub API is reachable"
            else
              echo "âŒ Cannot reach GitHub API - network issue"
            fi
            exit 1
          fi
          
          echo "âœ… GitHub API access validated"
          
          # Clone GitHub repository
          echo "ğŸ“¥ Cloning GitHub repository..."
          
          # Set Git credential helper timeout
          git config --global credential.helper 'cache --timeout=300'
          
          # Attempt to clone GitHub repository
          if ! git clone "https://${GITHUB_USERNAME}:${{secrets.sweetcoder_li_github_token}}@github.com/${GITHUB_REPO}.git" github-repo; then
            echo "âŒ Failed to clone GitHub repository"
            echo "Debugging information:"
            echo "  - Repository: ${GITHUB_REPO}"
            echo "  - Git version: $(git --version)"
            
            # Try alternative clone method
            echo "Trying alternative clone method..."
            if ! git clone "https://github.com/${GITHUB_REPO}.git" github-repo; then
              echo "âŒ Alternative clone method also failed"
              echo "Please check:"
              echo "  1. Repository ${GITHUB_REPO} exists and is publicly accessible"
              echo "  2. GitHub token has correct permissions"
              echo "  3. Network connectivity to GitHub"
              exit 1
            else
              echo "âœ… Repository cloned without authentication"
              echo "âš ï¸ Will configure authentication for push operations"
              cd github-repo
              git remote set-url origin "https://${{secrets.sweetcoder_li_github_token}}@github.com/${GITHUB_REPO}.git"
              cd ..
            fi
          else
            echo "âœ… Repository cloned successfully with authentication"
          fi
          
          cd github-repo
          
          # Fetch all remote branch information
          git fetch origin
          
          # Determine base branch
          PR_TARGET_BRANCH="main"
          
          # Generate random development branch name
          TIMESTAMP=$(date '+%Y%m%d-%H%M%S')
          RANDOM_SUFFIX=$(openssl rand -hex 4 2>/dev/null || echo $(( RANDOM % 10000 )))
          GITHUB_BRANCH="docs-sync-${TIMESTAMP}-${RANDOM_SUFFIX}"
          
          echo "ğŸ”„ Creating random development branch: $GITHUB_BRANCH"
          echo "ğŸ“‹ Base branch: $PR_TARGET_BRANCH"
          
          # Save branch name to environment for later steps
          echo "GITHUB_BRANCH=$GITHUB_BRANCH" >> $AONE_CI_ENV
          
          # Check if base branch exists
          if git show-ref --verify --quiet "refs/remotes/origin/$PR_TARGET_BRANCH"; then
            echo "âœ… Found base branch: $PR_TARGET_BRANCH"
            git checkout -b "$GITHUB_BRANCH" "origin/$PR_TARGET_BRANCH"
          else
            echo "âš ï¸ Base branch $PR_TARGET_BRANCH not found, trying main..."
            if git show-ref --verify --quiet "refs/remotes/origin/main"; then
              git checkout -b "$GITHUB_BRANCH" "origin/main"
              PR_TARGET_BRANCH="main"
            elif git show-ref --verify --quiet "refs/remotes/origin/master"; then
              git checkout -b "$GITHUB_BRANCH" "origin/master"
              PR_TARGET_BRANCH="master"
            else
              echo "âŒ No suitable base branch found (main/master)"
              exit 1
            fi
          fi
          
          echo "âœ… Created random development branch '$GITHUB_BRANCH' from '$PR_TARGET_BRANCH'"
          
          # Sync documentation files
          echo "ğŸ“‹ Syncing documentation files..."
          
          if [ "$SYNC_MODE" = "full" ]; then
            # Full sync: Remove existing docs directory and copy fresh
            echo "ğŸ”„ Full sync mode: Replacing entire docs directory"
            rm -rf docs/
            mkdir -p docs/
          else
            # Incremental sync: Keep existing structure, only update files
            echo "ğŸ“ˆ Incremental sync mode: Updating changed files"
            mkdir -p docs/
          fi
          
          # Copy documentation files
          echo "ğŸ“‚ Copying documentation files..."
          
          # Copy entire docs directory structure
          if [ -d "../../docs" ]; then
            cp -r ../../docs/* ./docs/ 2>/dev/null || true
            echo "âœ… Documentation files copied successfully"
          else
            echo "âŒ Source docs directory not found"
            exit 1
          fi
          
          # Display synced files
          echo "ğŸ“‹ Synced files:"
          find docs -type f | head -10
          TOTAL_FILES=$(find docs -type f | wc -l)
          echo "ğŸ“Š Total files synced: $TOTAL_FILES"
          
          # Check for changes
          git add docs/
          
          if git diff --staged --quiet; then
            echo "ğŸ“ No changes detected in documentation"
            echo "âœ… Documentation is already up to date"
          else
            # Commit changes
            COMMIT_TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            COMMIT_MESSAGE="ğŸ¤– Auto-sync documentation from GitLab CI [$COMMIT_TIMESTAMP]

            - Synced $TOTAL_FILES documentation files
            - Sync mode: $SYNC_MODE
            - Source: GitLab CI Pipeline
            - Triggered by: Documentation update"
            
            echo "ğŸ’¾ Committing changes..."
            git commit -m "$COMMIT_MESSAGE"
            
            # Push new branch to GitHub (ensure remote branch is created)
            echo "â¬†ï¸ Pushing new development branch to GitHub..."
            if git push -u origin "$GITHUB_BRANCH"; then
              echo "âœ… Documentation successfully pushed to GitHub!"
              echo "ğŸ”— View at: https://github.com/${GITHUB_REPO}/tree/${GITHUB_BRANCH}/docs"
              echo "ğŸ“‹ Branch Details:"
              echo "  - Development Branch: $GITHUB_BRANCH"
              echo "  - Files Changed: $TOTAL_FILES"
              echo "  - Repository: $GITHUB_REPO"
            else
              echo "âŒ Failed to push to GitHub"
              exit 1
            fi
          fi
          
          # Clean up working directory
          cd ../../
          rm -rf "$GITHUB_WORK_DIR"
          echo "ğŸ§¹ Cleanup completed"
      
      # Generate push report
      - id: generate-report
        name: "Generate Push Report"
        run: |
          echo "ğŸ“Š Documentation Push Report"
          echo "=================================="
          echo "âœ… Pipeline Status: SUCCESS"
          echo "ğŸ“… Execution Time: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“‚ Files Processed: ${DOCS_FILES_COUNT:-0}"
          echo "ğŸ¯ Target Repository: ${GITHUB_REPO:-'Not specified'}"
          echo "ğŸŒ¿ Development Branch: ${GITHUB_BRANCH:-'Generated randomly'}"
          echo "ğŸ”„ Sync Mode: ${{params.docs_sync_mode}}"
          echo "ğŸ¯ Base Branch: main"
          
          
          echo "=================================="
          echo "ğŸ”— GitHub Repository: https://github.com/${GITHUB_REPO}"
          echo "ğŸ“– Documentation: https://github.com/${GITHUB_REPO}/tree/${GITHUB_BRANCH}/docs"
          
          echo "ğŸ“ Development Branch: https://github.com/${GITHUB_REPO}/tree/${GITHUB_BRANCH}"
          
          echo "=================================="
