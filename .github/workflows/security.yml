name: Security Scanning

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run security scan every Monday at 2 AM
    - cron: '0 2 * * 1'
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety pip-audit

    - name: Run Safety check
      run: |
        safety check --json --output safety-report.json
        safety check  # Also output to console
      continue-on-error: true

    - name: Run pip-audit
      run: |
        pip-audit --format=json --output=pip-audit-report.json
        pip-audit  # Also output to console
      continue-on-error: true

    - name: Upload vulnerability reports
      uses: actions/upload-artifact@v3
      with:
        name: dependency-vulnerability-reports
        path: |
          safety-report.json
          pip-audit-report.json
      if: always()

  code-security-scan:
    name: Code Security Scan
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml] semgrep

    - name: Run Bandit security scan
      run: |
        bandit -r agb/ -f json -o bandit-report.json
        bandit -r agb/ -ll  # Also output to console
      continue-on-error: true

    - name: Run Semgrep security scan
      run: |
        semgrep --config=auto agb/ --json --output=semgrep-report.json
        semgrep --config=auto agb/  # Also output to console
      continue-on-error: true

    - name: Upload code security reports
      uses: actions/upload-artifact@v3
      with:
        name: code-security-reports
        path: |
          bandit-report.json
          semgrep-report.json
      if: always()

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: python
        # Can specify query suites
        queries: security-and-quality

    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:python"

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Get complete history

    - name: Install TruffleHog
      run: |
        curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

    - name: Run TruffleHog secret scan
      run: |
        trufflehog git file://. --json > trufflehog-report.json
        echo "Secret scan completed. Check trufflehog-report.json for results."
      continue-on-error: true

    - name: Check for high-confidence secrets
      run: |
        if [ -s trufflehog-report.json ]; then
          echo "âš ï¸ Potential secrets detected!"
          cat trufflehog-report.json
          # åœ¨å®žé™…çŽ¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥æ ¹æ® confidence çº§åˆ«å†³å®šæ˜¯å¦å¤±è´¥
        else
          echo "âœ… No secrets detected."
        fi

    - name: Upload secret scan report
      uses: actions/upload-artifact@v3
      with:
        name: secret-scan-report
        path: trufflehog-report.json
      if: always()

  license-scan:
    name: License Compliance Scan
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies and license tools
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pip-licenses licensecheck

    - name: Generate license report
      run: |
        pip-licenses --format=json --output-file=licenses.json
        pip-licenses --format=csv --output-file=licenses.csv
        pip-licenses  # è¾“å‡ºåˆ°æŽ§åˆ¶å°

    - name: Check license compatibility
      run: |
        licensecheck --zero
      continue-on-error: true

    - name: Upload license reports
      uses: actions/upload-artifact@v3
      with:
        name: license-reports
        path: |
          licenses.json
          licenses.csv

  supply-chain-scan:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install cyclonedx-bom
      run: |
        python -m pip install --upgrade pip
        pip install cyclonedx-bom

    - name: Generate SBOM
      run: |
        pip install -e .
        cyclonedx-py -o sbom.json
        cyclonedx-py -o sbom.xml --format xml

    - name: Upload SBOM
      uses: actions/upload-artifact@v3
      with:
        name: software-bill-of-materials
        path: |
          sbom.json
          sbom.xml

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security-scan, secret-scan, license-scan, supply-chain-scan]
    if: always()
    steps:
    - name: Download all security reports
      uses: actions/download-artifact@v3

    - name: Create security summary
      run: |
        cat > security-summary.md << 'EOF'
        # ðŸ›¡ï¸ Security Scan Results
        
        ## ðŸ“Š Scan Status
        | Scan Type | Status | Details |
        |-----------|--------|---------|
        | Dependency Vulnerabilities | ${{ needs.dependency-scan.result == 'success' && 'âœ… Clean' || 'âš ï¸ Issues Found' }} | Check dependency reports |
        | Code Security | ${{ needs.code-security-scan.result == 'success' && 'âœ… Clean' || 'âš ï¸ Issues Found' }} | Bandit & Semgrep analysis |
        | Secret Detection | ${{ needs.secret-scan.result == 'success' && 'âœ… Clean' || 'âš ï¸ Potential Secrets' }} | TruffleHog scan |
        | License Compliance | ${{ needs.license-scan.result == 'success' && 'âœ… Compliant' || 'âš ï¸ Check Required' }} | License compatibility |
        | Supply Chain | ${{ needs.supply-chain-scan.result == 'success' && 'âœ… Generated' || 'âŒ Failed' }} | SBOM generation |
        
        ## ðŸ” Key Findings
        
        ### High Priority Issues
        - Review any dependency vulnerabilities immediately
        - Address code security findings from Bandit/Semgrep
        - Remove any detected secrets from repository
        
        ### Recommendations
        - Keep dependencies updated regularly
        - Review and approve all license dependencies
        - Monitor security advisories for used packages
        - Implement secret management best practices
        
        ## ðŸ“‹ Next Steps
        1. Review detailed reports in artifacts
        2. Create issues for confirmed vulnerabilities
        3. Update security documentation if needed
        4. Schedule regular security reviews
        
        ---
        *Security scan completed on: $(date)*
        EOF

    - name: Upload security summary
      uses: actions/upload-artifact@v3
      with:
        name: security-summary
        path: security-summary.md

    - name: Check security gate
      run: |
        echo "Security Gate Evaluation:"
        
        # å®šä¹‰å…³é”®å®‰å…¨æ£€æŸ¥
        critical_failed=()
        
        # CodeQL é€šè¿‡ GitHub å†…ç½®æ£€æŸ¥ï¼Œè¿™é‡Œä¸»è¦æ£€æŸ¥å…¶ä»–æ‰«æ
        if [[ "${{ needs.dependency-scan.result }}" == "failure" ]]; then
          echo "âŒ Dependency scan found critical vulnerabilities"
          critical_failed+=("dependency-scan")
        fi
        
        if [[ "${{ needs.secret-scan.result }}" == "failure" ]]; then
          echo "âŒ Secret scan found potential credential leaks"
          critical_failed+=("secret-scan") 
        fi
        
        if [ ${#critical_failed[@]} -gt 0 ]; then
          echo "ðŸš¨ Security gate FAILED! Critical issues found in: ${critical_failed[*]}"
          echo "Please review security reports and address critical findings before proceeding."
          exit 1
        else
          echo "âœ… Security gate PASSED! No critical security issues detected."
        fi

  notify-security-team:
    name: Notify Security Issues
    runs-on: ubuntu-latest
    needs: [security-summary]
    if: failure() && github.ref == 'refs/heads/main'
    steps:
    - name: Send notification
      run: |
        echo "ðŸš¨ Security scan detected issues in main branch!"
        echo "Please review the security reports and take appropriate action."
        # è¿™é‡Œå¯ä»¥é›†æˆ Slack, Teams, æˆ–é‚®ä»¶é€šçŸ¥
        # ä¾‹å¦‚: curl -X POST -H 'Content-type: application/json' --data '{"text":"Security issues detected!"}' $SLACK_WEBHOOK