# AGB Python SDK CI/CD Pipeline
name: "AGB SDK Quality Assurance"

triggers:
  merge_request:
    target-branches:
    - "**"
    types:
    - "opened"
  push:
    branches:
    - "master"
    - "release_v*"

traits:
- type: "notification"
  properties:
    types:
    - "dingtalk"
    when:
    - "fail"
    users:
    - "68125"  # æ›¿æ¢ä¸ºå®é™…ç”¨æˆ·ID
    - "187788"  # æ›¿æ¢ä¸ºå®é™…ç”¨æˆ·ID
    webhooks:
    - "https://oapi.dingtalk.com/robot/send?access_token=eea6bd5473a4542870d3a33ebd678b8ba214f2f99a756ce04db1c3da8ba32280"
    dingtalkGroupIds:
    - "cid4XzFY99C8o2VZU/LaPj6BA=="

params:
  python_enabled:
    name: å¯ç”¨Pythonä»£ç æ‰«æ
    type: boolean
    default: true
  python_version:
    name: Pythonç‰ˆæœ¬
    type: string
    default: "3.10"
  security_scan_enabled:
    name: å¯ç”¨å®‰å…¨æ‰«æ
    type: boolean
    default: true
  unit_test_enabled:
    name: å¯ç”¨å•å…ƒæµ‹è¯•
    type: boolean
    default: false
  format_code_enabled:
    name: å¯ç”¨ä»£ç æ ¼å¼æ£€æŸ¥
    type: boolean
    default: true
  compare_to:
    name: å¯¹æ¯”ç›®æ ‡
    description: "é»˜è®¤åœ¨PUSHåœºæ™¯ä¸‹ä¸ºå‰ä¸€ä¸ªæäº¤ï¼ŒCRåœºæ™¯ä¸‹ä¸ºç›®æ ‡åˆ†æ”¯"
    type: string
    advanced: true
    default: "${{(git.merge_request != null ? git.merge_request.targetBranch : (git.push != null ? git.push.beforeSha256 : params.before_commit_id)) ?: git.defaultBranch}}"
  runs_on_resources:
    name: èµ„æºè§„æ ¼
    description: "è¿è¡Œæ—¶å®¹å™¨èµ„æºè§„æ ¼"
    default: "4-16Gi"
    options:
      - "4-16Gi"
      - "8-32Gi"
      - "16-64Gi"

jobs:
  setup:
    name: "ç¯å¢ƒå‡†å¤‡"
    runs-on:
      - "${{params.runs_on_resources}}"
    outputs:
      python_code: '${{steps.cloc.outputs.Python_code ?: "0"}}'
      python_code_inc: '${{steps.cloc.outputs.Python_added_code ?: "0"}}'
    image: alios-8u
    steps:
      - uses: checkout
      - uses: cloc
        id: cloc
        continue-on-error: false
        inputs:
          compare_to: "${{params.compare_to}}"
          write_outputs: true
      - uses: setup-env
        inputs:
          python-version: "${{params.python_version}}"



  code-quality-scan:
    name: "ä»£ç è´¨é‡æ‰«æ"
    needs: ["setup"]
    when: "${{params.python_enabled}}"
    timeout: "30m"
    runs-on:
      - "${{params.runs_on_resources}}"
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          python-version: "${{params.python_version}}"


      # ä»£ç æ ¼å¼æ£€æŸ¥
      - id: format-check
        when: "${{params.format_code_enabled}}"
        continue-on-error: true
        run: |
          echo "æ£€æŸ¥ä»£ç æ ¼å¼ï¼Œä¸ä¿®æ”¹æ–‡ä»¶..."
          python -m pip install --upgrade pip
          pip install black && black agb tests --exclude "agb/modules/browser/eval" --check --diff
          pip install isort && isort --check-only --diff --verbose agb tests --skip agb/modules/browser/eval
          echo "æ ¼å¼æ£€æŸ¥å®Œæˆ"

      # ä»£ç è´¨é‡æ£€æŸ¥
      - id: lint-check
        run: |
          echo "æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
          python -m pip install --upgrade pip
          pip install flake8 && flake8 agb tests --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=agb/modules/browser/eval
          echo "è´¨é‡æ£€æŸ¥å®Œæˆ"

      # ç±»å‹æ£€æŸ¥
      - id: type-check
        continue-on-error: false
        run: |
          echo "æ‰§è¡Œç±»å‹æ£€æŸ¥..."
          python -m pip install --upgrade pip
          pip install mypy
          pip install types-requests types-aiohttp types-Pillow types-setuptools types-pydantic || true
          mypy agb --install-types --no-error-summary --exclude 'agb/modules/browser/eval' --install-types --non-interactive
          echo "ç±»å‹æ£€æŸ¥å®Œæˆ"

  security-scan:
    name: "å®‰å…¨æ‰«æ"
    needs: ["setup"]
    when: "${{params.security_scan_enabled}}"
    timeout: "20m"
    runs-on:
      - "${{params.runs_on_resources}}"
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          python-version: "${{params.python_version}}"


      # Banditå®‰å…¨æ‰«æ
      - id: bandit-scan
        continue-on-error: false
        run: |
          echo "æ‰§è¡ŒBanditå®‰å…¨æ‰«æ..."
          python -m pip install --upgrade pip
          pip install bandit
          python -m bandit -r agb/ -v --skip B105,B106,B107 --exclude agb/modules/browser/eval
          echo "Banditæ‰«æå®Œæˆ"

      # Running security scans
      - id: pip-audit-scan
        continue-on-error: false
        run: |
          echo "æ‰§è¡Œpip-auditä¾èµ–æ¼æ´æ‰«æ..."
          python -m pip install --upgrade pip
          pip install pip-audit
          pip-audit --desc
          echo "ä¾èµ–æ¼æ´æ‰«æå®Œæˆ"

  # å•å…ƒæµ‹è¯•ï¼ˆæš‚æ—¶æ³¨é‡Šï¼Œå¾…æ·»åŠ æµ‹è¯•ç”¨ä¾‹åå¯ç”¨ï¼‰
  # unit-tests:
  #   name: "å•å…ƒæµ‹è¯•"
  #   needs: ["setup"]
  #   when: "${{params.unit_test_enabled && #number(jobs.setup.outputs.python_code) > 0}}"
  #   timeout: "20m"
  #   runs-on:
  #     - "${{params.runs_on_resources}}"
  #   steps:
  #     - uses: checkout
  #     - uses: setup-env
  #       inputs:
  #         python-version: "${{params.python_version}}"
  #
  #     - id: install-deps
  #       run: |
  #         echo "å®‰è£…æµ‹è¯•ä¾èµ–..."
  #         pip install -e .[test]
  #         echo "ä¾èµ–å®‰è£…å®Œæˆ"
  #
  #     - id: run-tests
  #       run: |
  #         echo "æ‰§è¡Œå•å…ƒæµ‹è¯•..."
  #         pytest tests/ -v --cov=agb --cov-report=term-missing --cov-report=xml:coverage.xml --cov-report=html:htmlcov/
  #         echo "å•å…ƒæµ‹è¯•å®Œæˆ"
  #
  #     - uses: upload-artifact
  #       inputs:
  #         retention-days: 30
  #         path: |
  #           coverage.xml
  #           htmlcov/**/*
  #           .coverage

  summary:
    name: "è´¨é‡æ£€æŸ¥æ€»ç»“"
    needs: ["code-quality-scan", "security-scan"]
    runs-on:
      - "4-16Gi"
    steps:
      - id: generate-summary
        run: |
          echo "=========================================="
          echo "         AGB SDK è´¨é‡æ£€æŸ¥å®Œæˆ"
          echo "=========================================="
          echo "âœ… ä»£ç è´¨é‡æ‰«æ: å·²å®Œæˆ"
          echo "âœ… å®‰å…¨æ‰«æ: å·²å®Œæˆ"

          echo "ğŸ“ å•å…ƒæµ‹è¯•: å¾…æ·»åŠ æµ‹è¯•ç”¨ä¾‹åå¯ç”¨"
          echo "=========================================="
          echo "è¯·æŸ¥çœ‹å„ä¸ªä»»åŠ¡çš„è¯¦ç»†æŠ¥å‘Šè·å–æ›´å¤šä¿¡æ¯"
          echo "=========================================="