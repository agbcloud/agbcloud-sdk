# AGB Python SDK CI/CD Pipeline
name: "AGB SDK Quality Assurance"

triggers:
  merge_request:
    target-branches:
    - master
    types:
    - opened

traits:
- type: "notification"
  properties:
    types:
    - "dingtalk"
    when:
    - "fail"
    users:
    - "68125"  # æ›¿æ¢ä¸ºå®é™…ç”¨æˆ·ID
    - "187788"  # æ›¿æ¢ä¸ºå®é™…ç”¨æˆ·ID
    webhooks:
    - "https://oapi.dingtalk.com/robot/send?access_token=eea6bd5473a4542870d3a33ebd678b8ba214f2f99a756ce04db1c3da8ba32280"
    dingtalkGroupIds:
    - "cid4XzFY99C8o2VZU/LaPj6BA=="

params:
  python_enabled:
    name: å¯ç”¨Pythonä»£ç æ‰«æ
    type: boolean
    default: true
  python_version:
    name: Pythonç‰ˆæœ¬
    type: string
    default: "3.10"
  security_scan_enabled:
    name: å¯ç”¨å®‰å…¨æ‰«æ
    type: boolean
    default: true
  unit_test_enabled:
    name: å¯ç”¨å•å…ƒæµ‹è¯•
    type: boolean
    default: true
  integration_test_enabled:
    name: å¯ç”¨é›†æˆæµ‹è¯•
    type: boolean
    default: true
  format_code_enabled:
    name: å¯ç”¨ä»£ç æ ¼å¼æ£€æŸ¥
    type: boolean
    default: true
  compare_to:
    name: å¯¹æ¯”ç›®æ ‡
    description: "é»˜è®¤åœ¨PUSHåœºæ™¯ä¸‹ä¸ºå‰ä¸€ä¸ªæäº¤ï¼ŒCRåœºæ™¯ä¸‹ä¸ºç›®æ ‡åˆ†æ”¯"
    type: string
    advanced: true
    default: "${{(git.merge_request != null ? git.merge_request.targetBranch : (git.push != null ? git.push.beforeSha256 : params.before_commit_id)) ?: git.defaultBranch}}"
  runs_on_resources:
    name: èµ„æºè§„æ ¼
    description: "è¿è¡Œæ—¶å®¹å™¨èµ„æºè§„æ ¼"
    default: "4-16Gi"
    options:
      - "4-16Gi"
      - "8-32Gi"
      - "16-64Gi"

jobs:
  setup:
    name: "ç¯å¢ƒå‡†å¤‡"
    runs-on:
      - "${{params.runs_on_resources}}"
    outputs:
      python_code: '${{steps.cloc.outputs.Python_code ?: "0"}}'
      python_code_inc: '${{steps.cloc.outputs.Python_added_code ?: "0"}}'
    image: alios-8u
    steps:
      - uses: checkout
      - uses: cloc
        id: cloc
        continue-on-error: false
        inputs:
          compare_to: "${{params.compare_to}}"
          write_outputs: true
      - uses: setup-env
        inputs:
          python-version: "${{params.python_version}}"



  code-quality-scan:
    name: "ä»£ç è´¨é‡æ‰«æ"
    needs: ["setup"]
    when: "${{params.python_enabled}}"
    timeout: "30m"
    runs-on:
      - "${{params.runs_on_resources}}"
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          python-version: "${{params.python_version}}"


      # ä»£ç æ ¼å¼æ£€æŸ¥
      - id: format-check
        when: "${{params.format_code_enabled}}"
        continue-on-error: true
        run: |
          echo "æ£€æŸ¥ä»£ç æ ¼å¼ï¼Œä¸ä¿®æ”¹æ–‡ä»¶..."
          python -m pip install --upgrade pip
          pip install black && black agb tests --exclude "agb/modules/browser/eval" --check --diff
          pip install isort && isort --check-only --diff --verbose agb tests --skip agb/modules/browser/eval
          echo "æ ¼å¼æ£€æŸ¥å®Œæˆ"

      # ä»£ç è´¨é‡æ£€æŸ¥
      - id: lint-check
        run: |
          echo "æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
          python -m pip install --upgrade pip
          pip install flake8 && flake8 agb tests --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=agb/modules/browser/eval
          echo "è´¨é‡æ£€æŸ¥å®Œæˆ"

      # ç±»å‹æ£€æŸ¥
      - id: type-check
        continue-on-error: false
        run: |
          echo "æ‰§è¡Œç±»å‹æ£€æŸ¥..."
          python -m pip install --upgrade pip
          pip install mypy
          pip install types-requests types-aiohttp types-Pillow types-setuptools types-pydantic || true
          mypy agb --install-types --no-error-summary --exclude 'agb/modules/browser/eval' --install-types --non-interactive
          echo "ç±»å‹æ£€æŸ¥å®Œæˆ"

  security-scan:
    name: "å®‰å…¨æ‰«æ"
    needs: ["setup"]
    when: "${{params.security_scan_enabled}}"
    timeout: "20m"
    runs-on:
      - "${{params.runs_on_resources}}"
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          python-version: "${{params.python_version}}"


      # Banditå®‰å…¨æ‰«æ
      - id: bandit-scan
        continue-on-error: false
        run: |
          echo "æ‰§è¡ŒBanditå®‰å…¨æ‰«æ..."
          python -m pip install --upgrade pip
          pip install bandit
          python -m bandit -r agb/ -v --skip B105,B106,B107 --exclude agb/modules/browser/eval
          echo "Banditæ‰«æå®Œæˆ"

      # Running security scans
      - id: pip-audit-scan
        continue-on-error: false
        run: |
          echo "æ‰§è¡Œpip-auditä¾èµ–æ¼æ´æ‰«æ..."
          python -m pip install --upgrade pip
          pip install pip-audit
          pip-audit --desc
          echo "ä¾èµ–æ¼æ´æ‰«æå®Œæˆ"

  # å•å…ƒæµ‹è¯•ï¼ˆæš‚æ—¶æ³¨é‡Šï¼Œå¾…æ·»åŠ æµ‹è¯•ç”¨ä¾‹åå¯ç”¨ï¼‰
  unit-tests:
    name: "å•å…ƒæµ‹è¯•"
    needs: ["setup"]
    when: "${{params.unit_test_enabled }}"
    timeout: "20m"
    runs-on:
      - "${{params.runs_on_resources}}"
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          python-version: "${{params.python_version}}"
      - id: run-tests
        run: |
          echo "æ‰§è¡Œå•å…ƒæµ‹è¯•..."
          pip install --upgrade pip
          pip install -e .[test]
          pip install pytest
          pytest tests/unit -v
          echo "å•å…ƒæµ‹è¯•å®Œæˆ"

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: "é›†æˆæµ‹è¯•"
    needs: ["setup"]
    when: "${{params.integration_test_enabled}}"
    timeout: "30m"
    runs-on:
      - "${{params.runs_on_resources}}"
    steps:
      - uses: checkout
      - uses: setup-env
        inputs:
          python-version: "${{params.python_version}}"
      - id: run-integration-tests
        run: |
          echo "è®¾ç½®ç¯å¢ƒå˜é‡..."
          export AGB_API_KEY="${{ secrets.agb_api_key_pre }}"
          
          # å®‰è£…DNSè§£æå·¥å…·
          echo "å®‰è£…DNSè§£æå·¥å…·..."
          if command -v yum >/dev/null 2>&1; then
            yum install -y bind-utils || echo "yumå®‰è£…å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•"
          elif command -v apt-get >/dev/null 2>&1; then
            apt-get update && apt-get install -y dnsutils || echo "apt-getå®‰è£…å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•"
          fi
          
          # åŠ¨æ€è·å–åŸŸåå¯¹åº”çš„IPåœ°å€
          echo "æ­£åœ¨è§£æåŸŸå IP åœ°å€..."
          DOMAIN="${{ vars.agb_endpoint_pre }}"
          
          # å°è¯•å¤šç§æ–¹æ³•è§£æåŸŸå
          RESOLVED_IP=""
          if command -v dig >/dev/null 2>&1; then
            RESOLVED_IP=$(dig +short "$DOMAIN" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
            echo "dig è§£ææˆåŠŸ"
          elif command -v nslookup >/dev/null 2>&1; then
            echo "å°è¯•ä½¿ç”¨ nslookup è§£æåŸŸå..."
            RESOLVED_IP=$(nslookup "$DOMAIN" | grep -A1 "Name:" | grep "Address:" | awk '{print $2}' | head -1)
            echo "nslookup è§£ææˆåŠŸ"
          elif command -v python3 >/dev/null 2>&1; then
            echo "å°è¯•ä½¿ç”¨ Python socket è§£æåŸŸå..."
            RESOLVED_IP=$(python3 -c "import socket; print(socket.gethostbyname('$DOMAIN'))" 2>/dev/null || echo "")
            echo "Python socket è§£ææˆåŠŸ"
          fi

          if [ -n "$RESOLVED_IP" ]; then
            echo "åŸŸåè§£ææˆåŠŸ"
            export AGB_ENDPOINT="http://$RESOLVED_IP"
          else
            echo "åŸŸåè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹åŸŸå"
            export AGB_ENDPOINT="${{ vars.agb_endpoint_pre }}"
            exit 1
          fi
          
          echo "æ‰§è¡Œé›†æˆæµ‹è¯•..."
          pip install --upgrade pip
          pip install -e .[test,dev]
          
          echo "ç¯å¢ƒå˜é‡å·²è®¾ç½®ï¼š"
          
          echo "å¼€å§‹è¿è¡Œé›†æˆæµ‹è¯•..."
          echo "=========================================="
          
          # åŠ¨æ€æ£€æµ‹ tests/integration ç›®å½•ä¸‹æ‰€æœ‰ Python æµ‹è¯•æ–‡ä»¶
          echo "æ­£åœ¨æ£€æµ‹é›†æˆæµ‹è¯•æ–‡ä»¶..."
          main_function_files=()
          pytest_files=()
          
          # æŸ¥æ‰¾æ‰€æœ‰ Python æ–‡ä»¶å¹¶æ£€æŸ¥æ˜¯å¦åŒ…å« main() å‡½æ•°
          for py_file in tests/integration/*.py; do
            if [ -f "$py_file" ]; then
              filename=$(basename "$py_file")
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åŒ…å« main() å‡½æ•°
              if grep -q "def main(" "$py_file"; then
                main_function_files+=("$filename")
                echo "  âœ… å‘ç°åŒ…å«main()å‡½æ•°çš„æµ‹è¯•æ–‡ä»¶: $filename (å°†ä½¿ç”¨ python æ‰§è¡Œ)"
              else
                pytest_files+=("$filename")
                echo "  âœ… å‘ç°pytestæµ‹è¯•æ–‡ä»¶: $filename (å°†ä½¿ç”¨ pytest æ‰§è¡Œ)"
              fi
            fi
          done
          
          echo ""
          echo "æ–‡ä»¶æ£€æµ‹ç»Ÿè®¡:"
          echo "  åŒ…å«main()å‡½æ•°çš„æ–‡ä»¶: ${#main_function_files[@]} ä¸ª"
          echo "  pytestæµ‹è¯•æ–‡ä»¶: ${#pytest_files[@]} ä¸ª"
          echo "  æ€»è®¡Pythonæµ‹è¯•æ–‡ä»¶: $((${#main_function_files[@]} + ${#pytest_files[@]})) ä¸ª"
          
          echo "=========================================="
          
          total_files=$((${#main_function_files[@]} + ${#pytest_files[@]}))
          if [ $total_files -eq 0 ]; then
            echo "âš ï¸  æœªå‘ç°ä»»ä½•é›†æˆæµ‹è¯•æ–‡ä»¶"
            echo "é›†æˆæµ‹è¯•è·³è¿‡"
            exit 0
          fi
          
          failed_tests=()
          passed_tests=()
          
          # æ‰§è¡ŒåŒ…å« main() å‡½æ•°çš„æµ‹è¯•æ–‡ä»¶
          for test_file in "${main_function_files[@]}"; do
            test_path="tests/integration/$test_file"
            if [ -f "$test_path" ]; then
              echo "è¿è¡Œæµ‹è¯• (python): $test_file"
              echo "------------------------------------------"
              
              # ç›´æ¥ä½¿ç”¨ python å‘½ä»¤æ‰§è¡Œæµ‹è¯•æ–‡ä»¶
              if python "$test_path"; then
                echo "âœ… $test_file: PASSED"
                passed_tests+=("$test_file")
              else
                echo "âŒ $test_file: FAILED"
                failed_tests+=("$test_file")
              fi
              
              echo "------------------------------------------"
              echo ""
            else
              echo "âš ï¸  æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨: $test_path"
            fi
          done
<<<<<<< HEAD
          
=======

          # ğŸ‘‡ åœ¨è¿™é‡Œæ’å…¥ 1 åˆ†é’Ÿç­‰å¾…,ç­‰å¾…ä¹‹å‰åˆ›å»ºçš„èµ„æºå›æ”¶å®Œæˆï¼Œå¦åˆ™ä¼šå¼•èµ·èµ„æºä¸è¶³çš„å¤±è´¥é—®é¢˜
          sleep 60

>>>>>>> ci:sleep 1 minute to wait for resource recyle finish
          # æ‰§è¡Œ pytest æµ‹è¯•æ–‡ä»¶
          for test_file in "${pytest_files[@]}"; do
            test_path="tests/integration/$test_file"
            if [ -f "$test_path" ]; then
              echo "è¿è¡Œæµ‹è¯• (pytest): $test_file"
              echo "------------------------------------------"
              
              # ä½¿ç”¨ pytest å‘½ä»¤æ‰§è¡Œæµ‹è¯•æ–‡ä»¶
              if python -m pytest "$test_path" -v; then
                echo "âœ… $test_file: PASSED"
                passed_tests+=("$test_file")
              else
                echo "âŒ $test_file: FAILED"
                failed_tests+=("$test_file")
              fi
              
              echo "------------------------------------------"
              echo ""
            else
              echo "âš ï¸  æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨: $test_path"
            fi
          done
          
          echo "=========================================="
          echo "é›†æˆæµ‹è¯•æ€»ç»“:"
          echo "  æ€»è®¡: $total_files ä¸ªæµ‹è¯•æ–‡ä»¶"
          echo "    - åŒ…å«main()å‡½æ•°: ${#main_function_files[@]} ä¸ª"
          echo "    - pytestæµ‹è¯•æ–‡ä»¶: ${#pytest_files[@]} ä¸ª"
          echo "  é€šè¿‡: ${#passed_tests[@]} ä¸ª"
          echo "  å¤±è´¥: ${#failed_tests[@]} ä¸ª"
          
          if [ ${#passed_tests[@]} -gt 0 ]; then
            echo ""
            echo "é€šè¿‡çš„æµ‹è¯•:"
            for test in "${passed_tests[@]}"; do
              echo "  âœ… $test"
            done
          fi
          
          if [ ${#failed_tests[@]} -gt 0 ]; then
            echo ""
            echo "å¤±è´¥çš„æµ‹è¯•:"
            for test in "${failed_tests[@]}"; do
              echo "  âŒ $test"
            done
            echo ""
            echo "é›†æˆæµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹"
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ æ‰€æœ‰é›†æˆæµ‹è¯•éƒ½å·²é€šè¿‡ï¼"
          echo "é›†æˆæµ‹è¯•å®Œæˆ"

  summary:
    name: "è´¨é‡æ£€æŸ¥æ€»ç»“"
    needs: ["code-quality-scan", "security-scan", "unit-tests","integration-tests"]
    runs-on:
      - "4-16Gi"
    steps:
      - id: generate-summary
        run: |
          echo "=========================================="
          echo "         AGB SDK è´¨é‡æ£€æŸ¥å®Œæˆ"
          echo "=========================================="
          echo "âœ… ä»£ç è´¨é‡æ‰«æ: å·²å®Œæˆ"
          echo "âœ… å®‰å…¨æ‰«æ: å·²å®Œæˆ"
          echo "âœ… å•å…ƒæµ‹è¯•: å·²å®Œæˆ"
          if [ "${{params.integration_test_enabled}}" = "true" ]; then
            echo "âœ… é›†æˆæµ‹è¯•: å·²å®Œæˆ"
          else
            echo "âš ï¸ é›†æˆæµ‹è¯•: å·²è·³è¿‡ï¼ˆæœªå¯ç”¨ï¼‰"
          fi
          echo "=========================================="